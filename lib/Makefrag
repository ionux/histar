OBJDIRS += lib lib/$(ARCH)

LIB_SRCFILES :=	\
	lib/$(ARCH)/strlen.S \
	lib/$(ARCH)/longjmp.S \
	lib/$(ARCH)/syscall_entry.S \
	lib/$(ARCH)/stack.S \
	lib/$(ARCH)/trapstub.S \
	lib/syscall.c \
	lib/printfmt.c \
	lib/printf.c \
	lib/string.c \
	lib/libmain.c \
	lib/panic.c \
	lib/console.c \
	lib/readline.c \
	lib/segment.c \
	lib/elf.c \
	lib/thread.c \
	lib/gatesrv.cc \
	lib/gateclnt.cc \
	lib/gateinvoke.cc \
	lib/taint.c \
	lib/netd_client.cc \
	lib/netd_gatesrv.cc \
	lib/netd_fd.c \
	lib/netd_lwip.c \
	lib/netd_lwipinit.c \
	lib/console.c \
	lib/spawn.cc \
	lib/container.c \
	lib/cksum.c \
	lib/fs_dir.cc \
	lib/fs_dir_ct.cc \
	lib/fs_dir_dseg.cc \
	lib/fs_dir_mlt.cc \
	lib/fs_file.cc \
	lib/fs_mount.c \
	lib/fs_taint.cc \
	lib/selftaint.cc \
	lib/label.c \
	lib/cpplabel.cc \
	lib/labelutil.cc \
	lib/nethelper.cc \
	lib/error.cc \
	lib/backtrace.c \
	lib/debug.cc \
	lib/privstore.cc \
	lib/sha1.c \
	lib/authclnt.cc \
	lib/groupclnt.cc \
	lib/utrap.c \
	lib/profiler.c \
	lib/tun.c \
	lib/declassify.cc \
	lib/resalloc.cc \
	lib/base64.c

include lib/$(ARCH)/Makefrag
include lib/cppsup/Makefrag
include lib/vt/Makefrag
#include lib/sqlite/Makefrag
#include lib/pcre/Makefrag

LIB_OBJFILES := $(LIB_SRCFILES)
LIB_OBJFILES := $(patsubst lib/%.c, $(OBJDIR)/lib/%.o, $(LIB_OBJFILES))
LIB_OBJFILES := $(patsubst lib/%.cc, $(OBJDIR)/lib/%.o, $(LIB_OBJFILES))
LIB_OBJFILES := $(patsubst lib/$(ARCH)/%.S, $(OBJDIR)/lib/%.o, $(LIB_OBJFILES))

$(OBJDIR)/lib/%.o: lib/%.c
	@mkdir -p $(@D)
	$(CC) $(USER_CFLAGS) $(CSTD) -D_GNU_SOURCE -Werror -c -o $@ $<

$(OBJDIR)/lib/%.o: lib/%.cc
	@mkdir -p $(@D)
	$(CXX) $(USER_CXXFLAGS) -Werror -c -o $@ $<

$(OBJDIR)/lib/%.o: lib/$(ARCH)/%.c
	@mkdir -p $(@D)
	$(CC) $(USER_CFLAGS) $(CSTD) -Werror -c -o $@ $<

$(OBJDIR)/lib/%.o: lib/$(ARCH)/%.S
	@mkdir -p $(@D)
	$(CC) $(USER_CFLAGS) -c -o $@ $<

$(OBJDIR)/lib/libjos.a: $(LIB_OBJFILES)
	rm -f $@
	$(AR) r $@ $(LIB_OBJFILES)
