OBJDIRS += lib lib/$(ARCH)

LIB_SRCFILES :=	\
	lib/$(ARCH)/strlen.S \
	lib/$(ARCH)/longjmp.S \
	lib/$(ARCH)/syscall_entry.S \
	lib/$(ARCH)/stack.S \
	lib/memcpy.c \
	lib/memmove.c \
	lib/memset.c \
	lib/syscall.c \
	lib/printfmt.c \
	lib/printf.c \
	lib/stdio.c \
	lib/string.c \
	lib/libmain.c \
	lib/panic.c \
	lib/console.c \
	lib/readline.c \
	lib/segment.c \
	lib/elf.c \
	lib/thread.c \
	lib/gate.c \
	lib/gatesrv.cc \
	lib/gateclnt.cc \
	lib/gateinvoke.cc \
	lib/taint.c \
	lib/netd_client.c \
	lib/netd_server.c \
	lib/fd.c \
	lib/console.c \
	lib/spawn.cc \
	lib/container.c \
	lib/cksum.c \
	lib/heap.c \
	lib/malloc.c \
	lib/fs_dir.cc \
	lib/fs_file.c \
	lib/fs_mount.c \
	lib/file.c \
	lib/label.c \
	lib/cpplabel.cc \
	lib/labelutil.cc \
	lib/nethelper.cc \
	lib/error.cc \
	lib/backtrace.c

include lib/$(ARCH)/Makefrag
include lib/lwip/Makefrag
include lib/cppsup/Makefrag
#include lib/btree/Makefrag
#include lib/sqlite/Makefrag
#include lib/pcre/Makefrag

LIB_OBJFILES := $(LIB_SRCFILES)
LIB_OBJFILES := $(patsubst lib/%.c, $(OBJDIR)/lib/%.o, $(LIB_OBJFILES))
LIB_OBJFILES := $(patsubst lib/%.cc, $(OBJDIR)/lib/%.o, $(LIB_OBJFILES))
LIB_OBJFILES := $(patsubst lib/$(ARCH)/%.S, $(OBJDIR)/lib/%.o, $(LIB_OBJFILES))

$(OBJDIR)/lib/%.o: lib/%.c
	@mkdir -p $(@D)
	$(CC) -nostdinc $(USER_CFLAGS) $(CSTD) $(CWARNS) -c -o $@ $<

$(OBJDIR)/lib/%.o: lib/%.cc
	@mkdir -p $(@D)
	$(CXX) -nostdinc $(USER_CXXFLAGS) $(CXXWARNS) -c -o $@ $<

$(OBJDIR)/lib/%.o: lib/$(ARCH)/%.c
	@mkdir -p $(@D)
	$(CC) -nostdinc $(USER_CFLAGS) $(CSTD) $(CWARNS) -c -o $@ $<

$(OBJDIR)/lib/%.o: lib/$(ARCH)/%.S
	@mkdir -p $(@D)
	$(CC) -nostdinc $(USER_CFLAGS) $(CWARNS)  -c -o $@ $<

$(OBJDIR)/lib/libjos.a: $(LIB_OBJFILES)
	rm -f $@
	$(AR) r $@ $(LIB_OBJFILES)
