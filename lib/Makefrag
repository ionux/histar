OBJDIRS += lib lib/$(ARCH)

include lib/$(ARCH)/Makefrag

#include lib/net/Makefrag
#include lib/sqlite/Makefrag
#include lib/pcre/Makefrag

LIB_SRCFILES :=	\
	lib/$(ARCH)/entry.S \
	lib/$(ARCH)/strlen.S \
	lib/$(ARCH)/longjmp.S \
	lib/memcpy.c \
	lib/memset.c \
	lib/$(ARCH)/syscall_entry.S \
	lib/syscall.c \
	lib/printfmt.c \
	lib/printf.c \
	lib/string.c \
	lib/libmain.c \
	lib/panic.c \
	lib/console.c \
	lib/readline.c \
	lib/segment.c \
	lib/elf.c

LIB_OBJFILES := $(patsubst lib/%.c, $(OBJDIR)/lib/%.o, $(LIB_SRCFILES))
LIB_OBJFILES := $(patsubst lib/$(ARCH)/%.S, $(OBJDIR)/lib/%.o, $(LIB_OBJFILES))

$(OBJDIR)/lib/%.o: lib/%.c
	@mkdir -p $(@D)
	$(CC) -nostdinc $(USER_CFLAGS) $(CSTD) -c -o $@ $<

$(OBJDIR)/lib/%.o: lib/$(ARCH)/%.c
	@mkdir -p $(@D)
	$(CC) -nostdinc $(USER_CFLAGS) $(CSTD) -c -o $@ $<

$(OBJDIR)/lib/%.o: lib/$(ARCH)/%.S
	@mkdir -p $(@D)
	$(CC) -nostdinc $(USER_CFLAGS) -c -o $@ $<

$(OBJDIR)/lib/libjos.a: $(LIB_OBJFILES)
	rm -f $@
	$(AR) r $@ $(LIB_OBJFILES)
