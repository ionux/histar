# -*-Makefile-*-

# The 0x000 link offset corresponds to the offset of the text section
# in the resulting ELF kernel file.  This way, the kernel ELF binary
# can be loaded at exactly 0x100000, without any further relocation.

# NB: locore.S must be first in the linking order to that <start> is in the
# loaded binary file at offset 0.
KERN_LDFLAGS = -N -Ttext 0x80010000 -e start -nostdlib
KERN_CFLAGS += -msoft-float -fno-builtin -Wno-missing-noreturn

KERN_ARCH :=					\
	$(ARCHDIR)/locore.S			\
	$(ARCHDIR)/init.c			\
	$(ARCHDIR)/pmap.c			\
	$(ARCHDIR)/page.c			\
	$(ARCHDIR)/trap.c			\
	$(ARCHDIR)/misc.c

KERN_LIB :=					\
	lib/$(ARCH)/longjmp.S			\
	lib/memcpy.c				\
	lib/memmove.c				\
	lib/memset.c				\
	lib/memcmp.c				\
	lib/printfmt.c				\
	lib/sysstring.c				\
	lib/cksum.c				\
	lib/bf60.c				\
	lib/string.c				\
	lib/cstrlen.c				\
	lib/hashtable.c

KERN_DEV :=					\
	dev/goldfish_irq.c			\
	dev/goldfish_timer.c			\
	dev/goldfish_ttycons.c

$(OBJDIR)/kern/kernel.%.debuginfo:
	$(LD) -o $@ $(KERN_LDFLAGS) $^ $(GCC_LIB)

all: $(OBJDIR)/kern/kernel.init $(OBJDIR)/boot/bimage.init

$(OBJDIR)/boot/bimage.%: $(OBJDIR)/kern/kernel.%
	@mkdir -p $(@D)
	$(OBJCOPY) -S -O binary $< $@

