# -*-Makefile-*-

# - Goldfish physical memory starts at 0. The kernel is loaded at 0x10000.
# - HTC Dream physical memory starts at 256MB. The kernel is loaded where the
#   boot sector header specifies (we use 0x10010000).
#
# In all cases, our kernel KVA is mapped to begin at 0x80000000.

# NB: locore.S must be first in the linking order to that <start> is in the
# loaded binary file at offset 0.
KERN_LDFLAGS = -N -Ttext 0x80010000 -e start -nostdlib
KERN_CFLAGS += -msoft-float -fno-builtin -Wno-missing-noreturn

KERN_ARCH :=					\
	$(ARCHDIR)/locore.S			\
	$(ARCHDIR)/exception.S			\
	$(ARCHDIR)/init.c			\
	$(ARCHDIR)/pmap.c			\
	$(ARCHDIR)/page.c			\
	$(ARCHDIR)/trap.c			\
	$(ARCHDIR)/misc.c

KERN_LIB :=					\
	lib/$(ARCH)/longjmp.S			\
	lib/memcpy.c				\
	lib/memmove.c				\
	lib/memset.c				\
	lib/memcmp.c				\
	lib/printfmt.c				\
	lib/sysstring.c				\
	lib/cksum.c				\
	lib/bf60.c				\
	lib/cstrlen.c				\
	lib/hashtable.c

KERN_DEV :=					\
	dev/goldfish_irq.c			\
	dev/goldfish_timer.c			\
	dev/goldfish_ttycons.c			\
	dev/msm_irq.c				\
	dev/msm_timer.c				\
	dev/msm_ttycons.c

$(OBJDIR)/kern/kernel.%.debuginfo:
	$(LD) -o $@ $(KERN_LDFLAGS) $^ $(GCC_LIB)

all: $(OBJDIR)/kern/kernel.init $(OBJDIR)/boot/bimage.init

$(OBJDIR)/boot/bimage.%: $(OBJDIR)/kern/kernel.%
	@mkdir -p $(@D)
	$(OBJCOPY) -S -O binary $< $@

